React는 useState를 포함한 훅들을 컴포넌트가 렌더링될 때 순서 기반으로 호출한다.
즉, 각 훅의 호출 순서에 따라 내부적으로 상태를 연결 리스트 형태로 저장하며, 이를 통해 이전 렌더링에서 저장된 상태와 현재 렌더링을 연결한다.
#### 렌더링과 useState의 위치

React는 컴포넌트가 렌더링될 때 훅들을 순서대로 호출 하면서 관리한다.
useState는 호출 순서에 따라 상태를 매핑 하는데, 이는 Fiber의 업데이트 과정과 직결된다.

- React가 훅을 순서 기반으로 추적한다.
- useState의 호출 순서가 변경되면, React는 기존 상태와 새로운 상태를 올바르게 매핑하지 못한다.

### Fiber의 관점에서 

- React의 Fiber 구조에서 상태는 링크드 리스트 형태로 관리된다.
- 각 useState는 Fiber노드의 memoizedState에 저장되며, 훅을 호출할 때마다 이 리스르틑 따라가면서 값을 가져온다.
- React는 `extra` 상태가 없다고 생각하다가, 새로운 훅이 추가되면서 `useState`의 순서가 바뀜
- 업데이트 시
	- 리렌더링이 발생하면, React는 기존 Fiber 트리에서 훅이 호출된 순서대로 이전 상태를 찾아 연결한다.
	- 상태가 변경되면 동일한 순서의 훅이 이전 값을 참조하여 업데이트한다
- useState는 호출 선수를 기준으로 상태를 저장하므로 조건문 안에서 호출하면 순서가 바뀌면서 오류가 발생한다.
- Fiber는 연결 리스트로 관리하는데, 순서가 어긋나면 올바른 상태를 가져오지 못한다.
- 훅은 항상 최상위에서 호출하야 React가 에측 가능한 방식으로 상태를 관리할 수 있다.

### Fiber의 상태 업데이트 및 재조정

``` jsx

	const [count, setCount] = useState(0);
	
	const handleClick = () => {
		// count = 3
		setCount(count + 1);
		setCount(count + 2);
		setCount(count + 3);
	};

```

### setState호출 시 마지막 상태만 적용되는 이유

React에서 setState를 여러 번 호출해도 마지막 호출만 적용되는 것처럼 보이는 이유는 React의 상태 업데이트 배치 및 재조정 과정과 연관된다.

- React의 상태 업데이트 배치 처리
- Fiber의 상태 스케줄링 및 재조정
- 최신 상태 적용을 위한 상태 병합

#### 상태 업데이트 배치 처리

React는 여러 개의 setState 호출을 한 번의 렌더링으로 처리하기 위해 상태 업데이트를 배치 처리한다.

- 동일한 렌더 사이클 내에서 상태 업데이트를 병합하기 때문이다.
- setState는 비동기적으로 실행되며, React는 모든 setState를 배치하여 하나의 최종 값으로 병합한다.
	- 실제 setState는 비동기 함수는 아니다, 다만 비동기적으로 실행된다.
	- queueMicrotask를 사용?
- React는 최신 setState 호출만 나기고 이전 호출을 덮어씌우는 방식으로 동작한다.

#### Fiber의 상태 스케줄링 및 재조정

React의 fiber는 상태 업데이트를 스케줄링 하며, 가능한 경우 재조정 단계를 최적화하여 불필요한 렌더링을 방지한다.